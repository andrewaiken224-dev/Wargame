<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>War Tracker + Map Builder (Offline) v7.4 (Smooth Paint + SVG Coastline + Lakes)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121a24; --panel2:#0f1620; --text:#e8eef7;
    --muted:#9fb0c7; --line:#223246; --accent:#7aa7ff;

    --friendly:#2b78ff; --hostile:#ff3b3b; --neutral:#2ecc71; --unknown:#ffd24a;

    --sea:#1c4f9a; --land:#2f7a4a; --forest:#1f5a3a; --mount:#7a6a57;
    --urban:#6f7a86; --desert:#9b8a52; --ice:#bfe9ff;

    --road:#e6e6e6; --river:#4aa0ff; --border:#ffcc66;

    --coast:#e8eef7;
    --coastHalo: rgba(0,0,0,.55);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; overflow:hidden;
    background:linear-gradient(180deg,#070a0f,#0b0f14);
    color:var(--text);
    font:14px/1.25 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .app{display:grid; grid-template-columns: 500px 1fr; height:100vh; width:100vw;}
  .sidebar{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border-right:1px solid var(--line);
    padding:14px; overflow:auto;
  }
  .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px;}
  .title{font-weight:900; letter-spacing:.3px; font-size:14px;}
  .title small{color:var(--muted);font-weight:800}
  .btn{
    background:#162235; border:1px solid #2a3d59; color:var(--text);
    padding:9px 11px; border-radius:12px; cursor:pointer;
    display:inline-flex; gap:8px; align-items:center; user-select:none; white-space:nowrap;
    font-weight:800;
  }
  .btn:hover{border-color:#3e5f8a}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#101b2a}
  .btn.danger{background:#2a1212;border-color:#5a2a2a}
  .btn.good{background:#132a18;border-color:#2a5a39}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row.nowrap{flex-wrap:nowrap}
  .row > *{flex:1}
  .card{
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    border-radius:16px; padding:12px; margin:10px 0;
  }
  .card h3{
    margin:0 0 10px 0; font-size:12px; letter-spacing:.6px;
    color:var(--muted); text-transform:uppercase;
  }
  label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
  input[type="text"], input[type="number"], select, textarea{
    width:100%; background:#0b1320; border:1px solid #223246;
    color:var(--text); padding:10px 10px; border-radius:12px; outline:none;
  }
  input:focus, select:focus, textarea:focus{
    border-color:#3e5f8a; box-shadow:0 0 0 3px rgba(122,167,255,.12);
  }
  .bigSelect{
    font-size:15px; padding:13px 12px; border-radius:14px;
    font-weight:850;
  }
  .hint{color:var(--muted); font-size:12px; margin-top:8px;}
  .sep{height:1px;background:var(--line);margin:10px 0}
  .pillbar{display:flex; gap:8px; flex-wrap:wrap}
  .pill{
    border:1px solid #2a3d59; background:#101b2a;
    border-radius:999px; padding:8px 11px; cursor:pointer;
    user-select:none; font-size:12px; font-weight:900;
  }
  .pill:hover{border-color:#3e5f8a}

  .main{position:relative; overflow:hidden; background:#05070b;}
  .canvasWrap{position:absolute; inset:0; display:grid; grid-template-rows: 52px 1fr 50px;}

  .mapTop, .mapBottom{
    display:flex; align-items:center; gap:10px; padding:10px 12px;
    background:rgba(8,11,16,.75); backdrop-filter: blur(8px);
  }
  .mapTop{border-bottom:1px solid var(--line)}
  .mapBottom{border-top:1px solid var(--line)}
  .badge{
    padding:6px 10px; border:1px solid #2a3d59; border-radius:999px;
    font-size:12px; color:var(--muted); background:rgba(16,27,42,.6);
  }
  .spacer{flex:1}
  .miniBtn{
    padding:7px 10px; border-radius:12px; border:1px solid #2a3d59;
    background:rgba(16,27,42,.55); color:var(--text); cursor:pointer;
    font-weight:900;
  }
  .miniBtn:hover{border-color:#3e5f8a}

  .mapArea{position:relative; overflow:auto;
    background:radial-gradient(circle at 30% 30%, rgba(122,167,255,.08), transparent 45%),
               radial-gradient(circle at 70% 70%, rgba(255,59,59,.06), transparent 45%);
  }
  .stage{
    position:relative; width:1600px; height:900px; margin:40px;
    border:1px dashed rgba(255,255,255,.16); border-radius:18px;
    background:#0a0e14; box-shadow:0 20px 70px rgba(0,0,0,.55);
    transform-origin:0 0;
    touch-action:none;
  }

  .mapImg{position:absolute; inset:0; z-index:1; pointer-events:none; width:100%; height:100%; object-fit:contain; border-radius:18px; background:#0a0e14;}
  .terrainCanvas{position:absolute; inset:0; z-index:2; border-radius:18px; pointer-events:none;}

  .coastSvg{position:absolute; inset:0; z-index:2.5; width:100%; height:100%; pointer-events:none;}
  .infraSvg{position:absolute; inset:0; z-index:3; width:100%; height:100%; pointer-events:none;}
  .overlaySvg{position:absolute; inset:0; z-index:4; width:100%; height:100%; pointer-events:none;}
  .unitsLayer{position:absolute; inset:0; z-index:5;}
  .interaction{ position:absolute; inset:0; z-index:6; pointer-events:none; background:transparent; touch-action:none; }

  .unit{ position:absolute; width:170px; height:102px; transform-origin:center center; pointer-events:auto; cursor:grab; user-select:none; -webkit-user-select:none; touch-action:none; filter: drop-shadow(0 6px 14px rgba(0,0,0,.35)); transition: left 120ms ease, top 120ms ease, width 120ms ease, height 120ms ease, transform 120ms ease; }
  .unit:active{cursor:grabbing}
  .unit.dragging{transition:none !important}
  .unit.selected{outline:2px solid rgba(122,167,255,.8); outline-offset:4px; border-radius:12px;}
  .handles{position:absolute; inset:-10px; pointer-events:none;}
  .handle{ position:absolute; width:12px;height:12px;border-radius:4px; background:rgba(122,167,255,.95); border:1px solid rgba(0,0,0,.55); pointer-events:auto; cursor:nwse-resize; }
  .handle.br{right:0;bottom:0}
  .handle.tr{right:0;top:0;cursor:nesw-resize}
  .handle.bl{left:0;bottom:0;cursor:nesw-resize}
  .handle.tl{left:0;top:0;cursor:nwse-resize}
  .rotHandle{ position:absolute; left:50%; top:-22px; transform:translateX(-50%); width:14px;height:14px;border-radius:999px; background:rgba(255,210,74,.95); border:1px solid rgba(0,0,0,.55); pointer-events:auto; cursor:grab; }
  .unitMeta{ position:absolute; left:10px; right:10px; bottom:6px; display:flex; justify-content:space-between; gap:8px; font-size:11px; color:#0b0f14; font-weight:950; pointer-events:none; }
  .unitMeta .id, .unitMeta .echelon{ padding:3px 6px; border-radius:9px; background:rgba(255,255,255,.88); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .unitMeta .id{max-width:70%}

  .turnSlider{width:260px}
  .layerToggles{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .toggle{ display:flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid #2a3d59; border-radius:999px; background:rgba(16,27,42,.45); cursor:pointer; user-select:none; color:var(--muted); font-size:12px; font-weight:900; }
  .toggle input{accent-color:var(--accent)}

  .toast{ position:fixed; right:16px; bottom:16px; z-index:9999; background:rgba(18,26,36,.92); border:1px solid #2a3d59; color:var(--text); padding:10px 12px; border-radius:12px; max-width:520px; display:none; font-weight:900; }
  .kbd{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:11px; padding:2px 6px; border-radius:8px; border:1px solid #2a3d59; background:#0b1320; color:var(--muted); }

  .unitHealth{position:absolute;left:10px;right:10px;top:8px;height:8px;background:rgba(255,255,255,.15);border-radius:999px;overflow:hidden}
  .unitHealth > i{display:block;height:100%;background:linear-gradient(90deg,#44d07f,#f5c84b,#ff5c5c)}
  .historyItem{padding:8px 10px;border:1px solid #2a3d59;border-radius:10px;margin:6px 0;cursor:pointer;background:#0e1827;font-size:12px}
  .historyItem:hover{border-color:#3e5f8a}
  .orderPath{stroke-dasharray:10 8; animation:dash 1s linear infinite;}
  @keyframes dash{to{stroke-dashoffset:-18}}
  .turnFlash{animation:turnFade .5s ease}
  @keyframes turnFade{0%{opacity:.45}100%{opacity:1}}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="topbar">
      <div class="title">War Tracker <small>‚Ä¢ Map Builder + SITMAP v7.4</small></div>
      <button class="btn secondary" id="btnHelp">Help</button>
    </div>
    <div class="card"><h3>Workflow</h3><div class="row"><button class="btn good" id="modeMapBuild">üß± Build Map</button><button class="btn" id="modeWarPlan">üó∫Ô∏è War Plan</button></div></div>
    <div class="card"><h3>Base Map (Optional)</h3><div class="row nowrap"><input type="file" id="mapFile" accept="image/png,image/jpeg,image/webp" /><button class="btn" id="btnClearMap">Clear</button></div><label>Stage size</label><div class="row"><input type="number" id="stageW" min="400" step="50" value="1600" /><input type="number" id="stageH" min="300" step="50" value="900" /></div><div class="row"><button class="btn" id="btnResizeStage">Apply</button><button class="btn secondary" id="btnFitStage">Fit View</button></div></div>

    <div class="card" id="mapBuildCard"><h3>Map Builder</h3>
      <div class="row"><button class="btn" id="toolPaint">üñå Smooth Paint</button><button class="btn" id="toolErase">üßΩ Erase</button></div>
      <div class="row"><button class="btn" id="toolPoly">üß© Polygon Fill</button><button class="btn" id="toolLabel">üè∑ Label</button><button class="btn secondary" id="toolSelectBuild">üñ± Select</button></div>
      <div class="row"><button class="btn" id="toolRoad">üõ£ Road</button><button class="btn" id="toolRiver">üåä River</button><button class="btn" id="toolBorder">üüß Border</button></div>
      <div class="row"><button class="btn" id="toolCity">üèô City/POI</button><button class="btn" id="toolStamp">üìå Stamp</button></div>
      <div class="row"><button class="btn secondary" id="btnFinishBuild">Finish</button><button class="btn secondary" id="btnCancelBuild">Cancel</button></div>
      <label>Brush</label><div class="row"><select id="brushPx"><option>10</option><option selected>18</option><option>28</option><option>40</option></select><select id="brushHard"><option value="0.2">Soft</option><option value="0.35" selected>Balanced</option><option value="0.55">Hard</option></select></div>
      <label>Terrain type</label><select id="terrainType" class="bigSelect"><option value="sea">Sea</option><option value="land">Land</option><option value="forest">Forest</option><option value="mountain">Mountain</option><option value="urban">Urban</option><option value="desert">Desert</option><option value="ice">Ice</option></select>
      <div class="row"><button class="btn secondary" id="btnClearTerrain">Clear Terrain</button><button class="btn secondary" id="btnSmoothEdges">üåÄ Smooth Edges</button></div>
      <label>Coast sampling</label><select id="coastStep" class="bigSelect"><option value="2">High</option><option value="4" selected>Balanced</option><option value="6">Fast</option></select>
      <div class="row"><select id="coastWidthOcean" class="bigSelect"><option value="2">Ocean Thin</option><option value="3" selected>Ocean Medium</option><option value="5">Ocean Thick</option></select><select id="coastWidthLake" class="bigSelect"><option value="1">Lake Hairline</option><option value="2" selected>Lake Thin</option><option value="4">Lake Thick</option></select></div>
      <div class="row"><button class="btn good" id="btnGenCoast">üåä Generate Ocean + Lakes</button><button class="btn secondary" id="btnClearCoast">Clear Coastlines</button></div>
      <label>Line width</label><select id="infraWidth" class="bigSelect"><option value="4">Thin</option><option value="7" selected>Medium</option><option value="10">Thick</option></select>
      <div class="row"><select id="poiType" class="bigSelect"><option value="city">City</option><option value="port">Port</option><option value="airfield">Airfield</option></select><input type="text" id="poiLabel" placeholder="POI label" /></div>
      <div class="row"><select id="stampType" class="bigSelect"><option value="bridge">Bridge</option><option value="radar">Radar</option><option value="factory">Factory</option></select><select id="stampSize" class="bigSelect"><option value="0.8">Small</option><option value="1.0" selected>Medium</option><option value="1.3">Large</option></select></div>
      <input type="text" id="stampLabel" placeholder="Stamp label" />
      <div class="row"><input type="text" id="labelText" placeholder="Label text" /><select id="labelSize" class="bigSelect"><option value="16">Small</option><option value="20" selected>Medium</option><option value="26">Large</option></select></div>
    </div>

    <div class="card" id="warPlanCard" style="display:none"><h3>War Planning (Units)</h3>
      <div class="row"><button class="btn secondary" id="toolSelectPlan">üñ± Select</button><button class="btn" id="toolFront">‚û∞ Front / LOA</button><button class="btn" id="toolZone">‚¨õ Zone / AO</button><button class="btn" id="toolNote">üìù Note</button></div>
      <div class="row"><button class="btn secondary" id="btnFinishPlan">Finish</button><button class="btn secondary" id="btnCancelPlan">Cancel</button></div>
      <label>Planning / Resolution</label><div class="row"><button class="btn good" id="btnPlanningPhase">Planning Phase</button><button class="btn" id="btnResolveTurn">Resolve Turn</button></div>
      <div class="row"><div class="badge">CP: <b id="cpLabel">0</b></div><div class="badge">Phase: <b id="phaseLabel">Planning</b></div></div>
      <label>Order actions</label><div class="row"><button class="btn" id="btnOrderMove">Move</button><button class="btn" id="btnOrderAttack">Attack</button><button class="btn" id="btnOrderDefend">Defend</button><button class="btn" id="btnOrderRecon">Recon</button></div>
      <div class="row"><button class="btn secondary" id="btnClearOrders">Clear Orders</button></div>
      <label>Affiliation + domain</label><div class="row"><select id="affil" class="bigSelect"><option value="friendly">Friendly</option><option value="hostile">Hostile</option><option value="neutral">Neutral</option><option value="unknown">Unknown</option></select><select id="domain" class="bigSelect"><option value="land">Land</option><option value="air">Air</option><option value="naval">Naval</option><option value="space">Space</option></select></div>
      <label>Echelon + Prefix</label><div class="row"><select id="echelon" class="bigSelect"><option>SQ</option><option>SEC</option><option>PLT</option><option>COY</option><option selected>BN</option><option>REG</option><option>BDE</option><option>DIV</option><option>CORPS</option><option>ARMY</option><option>AGRP</option></select><select id="prefix" class="bigSelect"><option>UCF</option><option>ALLY</option><option>OPFOR</option><option>NEUT</option></select></div>
      <input type="text" id="unitLabel" placeholder="Unit label" />
      <div class="row"><button class="btn good" id="btnAddUnit">‚ûï Add Unit</button><button class="btn danger" id="btnDeleteSelected">üóë Delete Selected</button></div>
      <div class="row"><button class="btn secondary" id="btnDuplicateSelected">üß¨ Duplicate</button><button class="btn secondary" id="btnFocusSelected">üéØ Focus</button></div>
      <label>Draw settings</label><div class="row"><select id="drawAffil" class="bigSelect"><option value="friendly">Friendly</option><option value="hostile">Hostile</option><option value="neutral">Neutral</option><option value="unknown">Unknown</option></select><select id="drawKind" class="bigSelect"><option value="front">Front</option><option value="ao">AO</option><option value="obj">Objective</option><option value="noGo">No-go</option></select></div>
      <label class="toggle" style="margin:0;display:inline-flex"><input type="checkbox" id="togCapture" checked /> Auto Capture</label>
      <input type="text" id="unitSearch" placeholder="Search" /><select id="unitType" class="bigSelect"></select>
      <div class="pillbar" id="quickBar"></div>
      <div class="sep"></div>
      <h3>Division Designer / ORBAT</h3>
      <div class="row"><input type="text" id="customName" placeholder="Template name" /><select id="customIcon" class="bigSelect"><option value="inf">Infantry</option><option value="mech">Mechanized</option><option value="armor">Armored</option><option value="arty">Artillery</option><option value="sam">Air Defense</option><option value="engineer">Engineer</option><option value="log">Logistics</option><option value="hq">HQ</option><option value="air">Aviation</option><option value="naval">Naval</option></select></div>
      <label class="toggle" style="margin:0;display:inline-flex"><input type="checkbox" id="customQuick" /> Show in Quick Bar</label>
      <div class="row"><button class="btn" id="btnAddCustomType">‚ûï Save Template</button><button class="btn secondary" id="btnResetTypes">Reset Defaults</button></div>
      <label>Readiness / Supply / Morale</label><div class="row"><select id="unitReadiness" class="bigSelect"><option value="full">Full</option><option value="reduced">Reduced</option><option value="minimal">Minimal</option></select><select id="unitSupply" class="bigSelect"><option value="well">Well-supplied</option><option value="low">Low</option><option value="out">Out</option></select><select id="unitMorale" class="bigSelect"><option value="high">High</option><option value="steady">Steady</option><option value="shaken">Shaken</option></select></div>
      <div class="hint">Right-click unit for quick actions. Hotkeys: <span class="kbd">A</span> attack <span class="kbd">M</span> move <span class="kbd">D</span> defend/recon cycle.</div>
    </div>

    <div class="card"><h3>Turn History Log</h3><div id="turnHistory" style="max-height:180px;overflow:auto"></div></div>

    <div class="card"><h3>Scenario Save / Load</h3><div class="row"><button class="btn" id="btnExport">Export JSON</button><button class="btn" id="btnImport">Import JSON</button></div><div class="row"><button class="btn secondary" id="btnExportPng">Export PNG</button><button class="btn secondary" id="btnNewBlank">New Blank</button></div><div class="row"><button class="btn danger" id="btnFactoryReset">Factory Reset</button></div><textarea id="ioBox" rows="7"></textarea></div>
  </aside>

  <main class="main">
    <div class="canvasWrap">
      <div class="mapTop"><span class="badge" id="modeBadge">Mode: Build Map</span><span class="badge" id="toolBadge">Tool: Paint</span><span class="badge" id="selectedBadge">Selected: none</span><span class="spacer"></span><button class="miniBtn" id="zoomOut">‚àí</button><button class="miniBtn" id="zoomIn">+</button><button class="miniBtn" id="zoomReset">Reset</button><span class="badge">Zoom: <span id="zoomPct">100%</span></span></div>
      <div class="mapArea" id="mapArea"><div class="stage" id="stage"><img class="mapImg" id="mapImg" alt="Map" /><canvas class="terrainCanvas" id="terrainCanvas"></canvas><svg class="coastSvg" id="coastSvg" viewBox="0 0 1600 900" preserveAspectRatio="none"></svg><svg class="infraSvg" id="infraSvg" viewBox="0 0 1600 900" preserveAspectRatio="none"></svg><svg class="overlaySvg" id="overlaySvg" viewBox="0 0 1600 900" preserveAspectRatio="none"></svg><div class="unitsLayer" id="unitsLayer"></div><div class="interaction" id="interaction"></div></div></div>
      <div class="mapBottom"><div class="badge">Turn: <b id="turnLabel">0</b></div><input class="turnSlider" id="turnSlider" type="range" min="0" max="0" value="0" /><button class="miniBtn" id="btnSnap">üíæ Snapshot</button><button class="miniBtn" id="btnNewTurn">‚ûï Turn</button><button class="miniBtn" id="btnReplay">‚ñ∂ Replay</button><span class="spacer"></span><div class="layerToggles"><label class="toggle"><input type="checkbox" id="togMapImg" checked/>PNG</label><label class="toggle"><input type="checkbox" id="togTerrain" checked/>Terrain</label><label class="toggle"><input type="checkbox" id="togCoast" checked/>Coast</label><label class="toggle"><input type="checkbox" id="togInfra" checked/>Infra</label><label class="toggle"><input type="checkbox" id="togUnits" checked/>Units</label><label class="toggle"><input type="checkbox" id="togOverlays" checked/>Overlays</label></div></div>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>
<div class="toast" id="turnSummary" style="left:50%;right:auto;top:18px;bottom:auto;transform:translateX(-50%);max-width:680px"></div>

<script>

/* ================= Utils ================= */
const $ = (id)=>document.getElementById(id);
const clamp=(min,max,v)=>Math.max(min,Math.min(max,v));
const deep=(v)=>JSON.parse(JSON.stringify(v));
function toast(msg){
  const t=$("toast"); t.textContent=msg; t.style.display="block";
  clearTimeout(toast._tm); toast._tm=setTimeout(()=>t.style.display="none",2600);
}
function cryptoRand(){
  const a=new Uint32Array(2); crypto.getRandomValues(a);
  return (a[0].toString(16)+a[1].toString(16)).slice(0,10);
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));}
function getCss(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }
function affilColor(affil){
  const map={friendly:"--friendly",hostile:"--hostile",neutral:"--neutral",unknown:"--unknown"};
  return getCss(map[affil]||"--friendly") || "#7aa7ff";
}
function terrainColor(type){
  const map={sea:"--sea",land:"--land",forest:"--forest",mountain:"--mount",urban:"--urban",desert:"--desert",ice:"--ice"};
  return getCss(map[type]||"--land");
}
function stagePointFromClient(ev){
  const rect=stageEl.getBoundingClientRect();
  return { x:(ev.clientX-rect.left)/state.stage.zoom, y:(ev.clientY-rect.top)/state.stage.zoom };
}
function dist2(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return dx*dx+dy*dy; }
function pointInPolygon(pt, poly){
  let inside=false;
  for(let i=0,j=poly.length-1;i<poly.length;j=i++){
    const xi=poly[i].x, yi=poly[i].y;
    const xj=poly[j].x, yj=poly[j].y;
    const intersect=((yi>pt.y)!==(yj>pt.y)) && (pt.x < (xj-xi)*(pt.y-yi)/((yj-yi)||1e-9) + xi);
    if(intersect) inside=!inside;
  }
  return inside;
}

const stageEl=$("stage");
const mapArea=$("mapArea");
const mapImgEl=$("mapImg");
const terrainCanvas=$("terrainCanvas");
const tctx=terrainCanvas.getContext("2d");
const coastSvg=$("coastSvg");
const infraSvg=$("infraSvg");
const overlaySvg=$("overlaySvg");
const unitsLayer=$("unitsLayer");
const interaction=$("interaction");
const AUTOSAVE_KEY="war_tracker_v74_autosave";

const DEFAULT_TEMPLATES={
  inf_bn:{name:"INF BN",icon:"inf",quick:true,group:"Land ‚Ä¢ Maneuver"},
  mech_bn:{name:"MECH BN",icon:"mech",quick:true,group:"Land ‚Ä¢ Maneuver"},
  armor_bn:{name:"TANK BN",icon:"armor",quick:true,group:"Land ‚Ä¢ Maneuver"},
  arty_bn:{name:"ARTY BN",icon:"arty",quick:true,group:"Land ‚Ä¢ Fires"},
  sam_bn:{name:"SAM BN",icon:"sam",quick:true,group:"Land ‚Ä¢ Fires"},
  hq:{name:"HQ / CMD",icon:"hq",quick:true,group:"Land ‚Ä¢ Support"},
  fighter_sq:{name:"FTR SQ",icon:"air",quick:true,group:"Air"},
  csg:{name:"CSG",icon:"naval",quick:true,group:"Naval"},
  sub:{name:"SUB",icon:"sub",quick:true,group:"Naval"},
  ew_det:{name:"EW DET",icon:"cyber",quick:true,group:"Cyber/EW/Space"}
};

const state={
  stage:{w:1600,h:900,zoom:1}, mapDataUrl:"", appMode:"build", tool:"paint",
  temp:{points:[],kind:null}, infraShapes:[], shapes:[], units:[], snapshots:[], turn:0,
  selected:{kind:null,id:null}, idCounters:{}, templates:deep(DEFAULT_TEMPLATES),
  coast:{enabled:true,oceanWidth:3,lakeWidth:2,oceanD:"",lakeD:""},
  paint:{down:false,last:null}, replay:{on:false,timer:null}
};

function updateInteractionPointerEvents(){
  const needsClicks=(state.appMode==="build" && state.tool!=="selectBuild") || (state.appMode==="plan" && state.tool!=="selectPlan");
  interaction.style.pointerEvents=needsClicks?"all":"none";
}

function rebuildUnitTypeDropdown(filter=""){
  const sel=$("unitType"); sel.innerHTML="";
  const f=filter.toLowerCase().trim();
  const items=Object.entries(state.templates).map(([k,v])=>({k,...v})).filter(it=>!f||it.name.toLowerCase().includes(f)||it.k.includes(f));
  const byGroup={};
  for(const it of items){(byGroup[it.group||"Other"]??=[]).push(it);}
  for(const g of Object.keys(byGroup).sort()){
    const og=document.createElement("optgroup"); og.label=g;
    for(const it of byGroup[g].sort((a,b)=>a.name.localeCompare(b.name))){
      const o=document.createElement("option"); o.value=it.k; o.textContent=it.name; og.appendChild(o);
    }
    sel.appendChild(og);
  }
}
function rebuildQuickBar(){
  const bar=$("quickBar"); bar.innerHTML="";
  Object.entries(state.templates).filter(([,v])=>v.quick).forEach(([k,v])=>{
    const pill=document.createElement("div"); pill.className="pill"; pill.textContent=v.name; pill.onclick=()=>{$("unitType").value=k; addUnit();}; bar.appendChild(pill);
  });
}

function setZoom(z){ state.stage.zoom=clamp(0.25,3,z); stageEl.style.transform=`scale(${state.stage.zoom})`; $("zoomPct").textContent=Math.round(state.stage.zoom*100)+"%"; }
$("zoomIn").onclick=()=>setZoom(state.stage.zoom*1.1);
$("zoomOut").onclick=()=>setZoom(state.stage.zoom/1.1);
$("zoomReset").onclick=()=>setZoom(1);

function fitStage(){
  const sx=(mapArea.clientWidth-80)/state.stage.w, sy=(mapArea.clientHeight-80)/state.stage.h;
  setZoom(Math.min(sx,sy,1.6)); mapArea.scrollLeft=0; mapArea.scrollTop=0;
}
$("btnFitStage").onclick=fitStage;

function applyStageSize(w,h){
  state.stage.w=w; state.stage.h=h;
  stageEl.style.width=w+"px"; stageEl.style.height=h+"px";
  terrainCanvas.width=w; terrainCanvas.height=h;
  coastSvg.setAttribute("viewBox",`0 0 ${w} ${h}`); infraSvg.setAttribute("viewBox",`0 0 ${w} ${h}`); overlaySvg.setAttribute("viewBox",`0 0 ${w} ${h}`);
  renderAll(); fitStage();
}
$("btnResizeStage").onclick=()=>applyStageSize(parseInt($("stageW").value,10)||1600, parseInt($("stageH").value,10)||900);

function setAppMode(m){
  state.appMode=m;
  $("modeBadge").textContent="Mode: "+(m==="build"?"Build Map":"War Plan");
  $("mapBuildCard").style.display=m==="build"?"block":"none";
  $("warPlanCard").style.display=m==="plan"?"block":"none";
  setTool(m==="build"?"paint":"selectPlan");
}
$("modeMapBuild").onclick=()=>setAppMode("build");
$("modeWarPlan").onclick=()=>setAppMode("plan");

function toolLabel(t){
  return ({paint:"Smooth Paint",erase:"Erase",poly:"Polygon Fill",label:"Label",road:"Road",river:"River",border:"Border",city:"City/POI",stamp:"Stamp",selectBuild:"Select (Build)",selectPlan:"Select",front:"Front/LOA",zone:"Zone/AO",note:"Note"})[t]||t;
}
function setTool(t){ state.tool=t; $("toolBadge").textContent="Tool: "+toolLabel(t); state.temp.points=[]; updateInteractionPointerEvents(); }
$("toolPaint").onclick=()=>setTool("paint"); $("toolErase").onclick=()=>setTool("erase"); $("toolPoly").onclick=()=>setTool("poly"); $("toolLabel").onclick=()=>setTool("label");
$("toolRoad").onclick=()=>setTool("road"); $("toolRiver").onclick=()=>setTool("river"); $("toolBorder").onclick=()=>setTool("border"); $("toolCity").onclick=()=>setTool("city");
$("toolStamp").onclick=()=>setTool("stamp"); $("toolSelectBuild").onclick=()=>setTool("selectBuild"); $("toolSelectPlan").onclick=()=>setTool("selectPlan");
$("toolFront").onclick=()=>setTool("front"); $("toolZone").onclick=()=>setTool("zone"); $("toolNote").onclick=()=>setTool("note");

function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
$("mapFile").addEventListener("change", async (e)=>{ const f=e.target.files?.[0]; if(!f) return; state.mapDataUrl=await fileToDataURL(f); mapImgEl.src=state.mapDataUrl; toast("Map image loaded."); });
$("btnClearMap").onclick=()=>{state.mapDataUrl=""; mapImgEl.removeAttribute("src"); toast("Map image cleared.");};

function clearTerrain(){ tctx.clearRect(0,0,terrainCanvas.width,terrainCanvas.height); }
$("btnClearTerrain").onclick=()=>{ clearTerrain(); toast("Terrain cleared."); };
function drawBrushDot(x,y,type,erase=false){
  const r=parseInt($("brushPx").value,10)||18; const hard=parseFloat($("brushHard").value)||0.35;
  const g=tctx.createRadialGradient(x,y,r*hard,x,y,r); g.addColorStop(0, erase?"rgba(0,0,0,1)":terrainColor(type)); g.addColorStop(1, erase?"rgba(0,0,0,0)":"rgba(0,0,0,0)");
  tctx.save(); tctx.globalCompositeOperation=erase?"destination-out":"source-over"; tctx.globalAlpha=erase?1:0.9; tctx.fillStyle=g; tctx.beginPath(); tctx.arc(x,y,r,0,Math.PI*2); tctx.fill(); tctx.restore();
}
function paintMove(p,type,erase){
  const last=state.paint.last||p; const d=Math.hypot(p.x-last.x,p.y-last.y); const step=Math.max(2,(parseInt($("brushPx").value,10)||18)/3);
  for(let i=0;i<=d;i+=step){ const t=d?i/d:0; drawBrushDot(last.x+(p.x-last.x)*t,last.y+(p.y-last.y)*t,type,erase); }
  state.paint.last=p;
}

function isSeaPixel(data,w,x,y){ const i=(y*w+x)*4; return data[i+2]>data[i+1] && data[i+2]>60; }
function marchingSquaresSegments(mask,w,h,step=4){
  const segs=[];
  for(let y=0;y<h-step;y+=step){
    for(let x=0;x<w-step;x+=step){
      const tl=mask(y,x), tr=mask(y,x+step), br=mask(y+step,x+step), bl=mask(y+step,x);
      const idx=(tl?8:0)|(tr?4:0)|(br?2:0)|(bl?1:0); if(idx===0||idx===15) continue;
      const xm=x+step/2, ym=y+step/2;
      if([1,14].includes(idx)) segs.push([[x,ym],[xm,y+step]]);
      else if([2,13].includes(idx)) segs.push([[xm,y+step],[x+step,ym]]);
      else if([4,11].includes(idx)) segs.push([[xm,y],[x+step,ym]]);
      else if([8,7].includes(idx)) segs.push([[x,ym],[xm,y]]);
      else if([3,12].includes(idx)) segs.push([[x,ym],[x+step,ym]]);
      else if([6,9].includes(idx)) segs.push([[xm,y],[xm,y+step]]);
      else { segs.push([[x,ym],[xm,y]]); segs.push([[xm,y+step],[x+step,ym]]); }
    }
  }
  return segs;
}
function segmentsToPath(segs){
  return segs.map(([a,b])=>`M${a[0].toFixed(1)},${a[1].toFixed(1)} L${b[0].toFixed(1)},${b[1].toFixed(1)}`).join(" ");
}
function generateOceanAndLakes(){
  const w=terrainCanvas.width,h=terrainCanvas.height, step=parseInt($("coastStep").value,10)||4;
  const img=tctx.getImageData(0,0,w,h).data;
  const sea=(y,x)=>{x=Math.max(0,Math.min(w-1,x));y=Math.max(0,Math.min(h-1,y));return isSeaPixel(img,w,x,y);};
  const edgeQ=[], seen=new Set();
  const key=(x,y)=>`${x},${y}`;
  const push=(x,y)=>{const k=key(x,y); if(!seen.has(k)&&sea(y,x)){seen.add(k); edgeQ.push([x,y]);}};
  for(let x=0;x<w;x+=step){push(x,0); push(x,h-1);} for(let y=0;y<h;y+=step){push(0,y); push(w-1,y);}
  const ocean=new Set();
  while(edgeQ.length){ const [x,y]=edgeQ.pop(); const k=key(x,y); ocean.add(k); [[step,0],[-step,0],[0,step],[0,-step]].forEach(([dx,dy])=>{const nx=x+dx,ny=y+dy,kk=key(nx,ny); if(nx>=0&&ny>=0&&nx<w&&ny<h&&!seen.has(kk)&&sea(ny,nx)){seen.add(kk); edgeQ.push([nx,ny]);}}); }
  const oceanMask=(y,x)=>sea(y,x)&&ocean.has(key(x,y));
  const lakeMask=(y,x)=>sea(y,x)&&!ocean.has(key(x,y));
  state.coast.oceanD=segmentsToPath(marchingSquaresSegments(oceanMask,w,h,step));
  state.coast.lakeD=segmentsToPath(marchingSquaresSegments(lakeMask,w,h,step));
  state.coast.oceanWidth=parseInt($("coastWidthOcean").value,10)||3;
  state.coast.lakeWidth=parseInt($("coastWidthLake").value,10)||2;
  renderCoast(); toast("Generated ocean + lake coastlines.");
}
$("btnGenCoast").onclick=generateOceanAndLakes;
$("btnClearCoast").onclick=()=>{state.coast.oceanD=""; state.coast.lakeD=""; renderCoast(); toast("Coastlines cleared.");};

function renderCoast(){
  coastSvg.replaceChildren();
  const mk=(d,w)=>{const p=document.createElementNS("http://www.w3.org/2000/svg","path"); p.setAttribute("d",d); p.setAttribute("fill","none"); p.setAttribute("stroke",getCss("--coast")); p.setAttribute("stroke-width",w); p.setAttribute("stroke-linecap","round"); p.setAttribute("stroke-linejoin","round"); return p;};
  if(state.coast.oceanD) coastSvg.appendChild(mk(state.coast.oceanD,state.coast.oceanWidth));
  if(state.coast.lakeD) coastSvg.appendChild(mk(state.coast.lakeD,state.coast.lakeWidth));
  applyLayerToggles();
}
function renderInfra(){
  infraSvg.replaceChildren();
  for(const s of state.infraShapes){
    if(s.kind==="line"){
      const el=document.createElementNS("http://www.w3.org/2000/svg","polyline"); el.setAttribute("points",s.points.map(p=>`${p.x},${p.y}`).join(" ")); el.setAttribute("fill","none");
      const c=s.lineType==="road"?getCss("--road"):s.lineType==="river"?getCss("--river"):getCss("--border"); el.setAttribute("stroke",c); el.setAttribute("stroke-width",s.width||7); if(s.lineType==="border") el.setAttribute("stroke-dasharray","14 9"); el.setAttribute("stroke-linecap","round"); el.setAttribute("stroke-linejoin","round"); infraSvg.appendChild(el);
    } else if(["poi","stamp","label"].includes(s.kind)){
      const t=document.createElementNS("http://www.w3.org/2000/svg","text"); t.setAttribute("x",s.x); t.setAttribute("y",s.y); t.setAttribute("fill","#fff"); t.setAttribute("font-size",s.size||14); t.textContent=s.kind==="label"?s.text:(s.label||s.poiType||s.stampType||s.kind); infraSvg.appendChild(t);
    }
  }
  applyLayerToggles();
}
function overlayToSvg(s){
  const base=affilColor(s.affil||"friendly");
  if(s.kind==="front"){ const el=document.createElementNS("http://www.w3.org/2000/svg","polyline"); el.setAttribute("points",s.points.map(p=>`${p.x},${p.y}`).join(" ")); el.setAttribute("fill","none"); el.setAttribute("stroke",base); el.setAttribute("stroke-width","6"); el.setAttribute("stroke-linecap","round"); el.setAttribute("stroke-linejoin","round"); return el; }
  if(s.kind==="zone"){ const el=document.createElementNS("http://www.w3.org/2000/svg","polygon"); el.setAttribute("points",s.points.map(p=>`${p.x},${p.y}`).join(" ")); el.setAttribute("fill",base); el.setAttribute("opacity","0.12"); el.setAttribute("stroke",base); el.setAttribute("stroke-width","3"); return el; }
  const el=document.createElementNS("http://www.w3.org/2000/svg","text"); el.setAttribute("x",s.points[0].x); el.setAttribute("y",s.points[0].y); el.setAttribute("fill",base); el.setAttribute("font-size","18"); el.textContent=s.text||"NOTE"; return el;
}
function renderOverlays(){ overlaySvg.replaceChildren(); for(const s of state.shapes) overlaySvg.appendChild(overlayToSvg(s)); applyLayerToggles(); }

function nextId(prefix,echelon){ const k=`${prefix}_${echelon}`; state.idCounters[k]=(state.idCounters[k]||0)+1; return `${prefix}-${state.idCounters[k]}${echelon}`; }
function unitSvg(u){
  const tpl=state.templates[u.typeKey]||{name:"UNIT"};
  return `<svg viewBox='0 0 200 120' xmlns='http://www.w3.org/2000/svg'><rect x='20' y='18' width='160' height='84' rx='8' fill='rgba(0,0,0,.35)' stroke='${affilColor(u.affil)}' stroke-width='4'/><text x='100' y='64' text-anchor='middle' fill='white' font-weight='900' font-size='15'>${escapeHtml(tpl.name)}</text></svg>`;
}
function addUnit(){
  if(state.appMode!=="plan") return toast("Switch to War Plan mode to place units.");
  const typeKey=$("unitType").value; const tpl=state.templates[typeKey]; if(!tpl) return;
  const echelon=$("echelon").value, prefix=$("prefix").value;
  const u={id:nextId(prefix,echelon),typeKey,label:$("unitLabel").value.trim()||tpl.name,affil:$("affil").value,domain:$("domain").value,echelon,x:140+Math.random()*180,y:120+Math.random()*170,w:170,h:102,rot:0};
  state.units.push(u); state.selected={kind:"unit",id:u.id}; renderUnits(); toast("Unit added.");
}
$("btnAddUnit").onclick=addUnit;
function renderUnits(){
  unitsLayer.innerHTML="";
  for(const u of state.units){
    const el=document.createElement("div"); el.className="unit"+(state.selected.kind==="unit"&&state.selected.id===u.id?" selected":"");
    el.style.left=u.x+"px"; el.style.top=u.y+"px"; el.style.width=u.w+"px"; el.style.height=u.h+"px"; el.style.transform=`rotate(${u.rot}deg)`;
    el.innerHTML=unitSvg(u)+`<div class='unitMeta'><div class='id'>${escapeHtml(u.id)}</div><div class='echelon'>${escapeHtml(u.echelon)}</div></div>`;
    el.onpointerdown=(ev)=>{ if(state.appMode!=="plan"||state.tool!=="selectPlan") return; ev.preventDefault(); state.selected={kind:"unit",id:u.id}; const s=stagePointFromClient(ev),ox=u.x,oy=u.y; const mm=(e)=>{const p=stagePointFromClient(e); u.x=clamp(0,state.stage.w-u.w,ox+(p.x-s.x)); u.y=clamp(0,state.stage.h-u.h,oy+(p.y-s.y)); el.style.left=u.x+"px"; el.style.top=u.y+"px";}; const mu=()=>{window.removeEventListener("pointermove",mm);window.removeEventListener("pointerup",mu);}; window.addEventListener("pointermove",mm,{passive:false}); window.addEventListener("pointerup",mu,{passive:false}); };
    unitsLayer.appendChild(el);
  }
  applyLayerToggles();
}

function renderAll(){ renderCoast(); renderInfra(); renderOverlays(); renderUnits(); }
function select(kind,id){ state.selected={kind,id}; $("selectedBadge").textContent=`Selected: ${kind} ${id}`; renderUnits(); renderInfra(); }
function clearSelection(){ state.selected={kind:null,id:null}; $("selectedBadge").textContent="Selected: none"; }

function finishTemp(){
  const t=state.tool;
  if(state.appMode==="build" && t==="poly"){
    if(state.temp.points.length<3) return toast("Polygon needs 3+ points.");
    tctx.save(); tctx.fillStyle=terrainColor($("terrainType").value); tctx.globalAlpha=.72; tctx.beginPath(); tctx.moveTo(state.temp.points[0].x,state.temp.points[0].y); for(let i=1;i<state.temp.points.length;i++) tctx.lineTo(state.temp.points[i].x,state.temp.points[i].y); tctx.closePath(); tctx.fill(); tctx.restore();
    state.temp.points=[]; return toast("Polygon filled.");
  }
  if(state.appMode==="build" && ["road","river","border"].includes(t)){
    if(state.temp.points.length<2) return toast("Need 2+ points.");
    state.infraShapes.push({id:"L-"+cryptoRand(),kind:"line",lineType:t,width:parseInt($("infraWidth").value,10)||7,points:deep(state.temp.points)}); state.temp.points=[]; renderInfra(); return toast("Line saved.");
  }
  if(state.appMode==="plan" && t==="front"){
    if(state.temp.points.length<2) return toast("Need 2+ points.");
    state.shapes.push({id:"F-"+cryptoRand(),kind:"front",affil:$("drawAffil").value,drawKind:$("drawKind").value,points:deep(state.temp.points)}); state.temp.points=[]; renderOverlays(); return toast("Front saved.");
  }
  if(state.appMode==="plan" && t==="zone"){
    if(state.temp.points.length<3) return toast("Need 3+ points.");
    state.shapes.push({id:"Z-"+cryptoRand(),kind:"zone",affil:$("drawAffil").value,drawKind:$("drawKind").value,points:deep(state.temp.points)}); state.temp.points=[]; renderOverlays(); return toast("Zone saved.");
  }
}
$("btnFinishBuild").onclick=finishTemp; $("btnFinishPlan").onclick=finishTemp;
$("btnCancelBuild").onclick=()=>{state.temp.points=[]; toast("Cancelled.");}; $("btnCancelPlan").onclick=()=>{state.temp.points=[]; toast("Cancelled.");};

interaction.addEventListener("pointerdown",(ev)=>{
  const p=stagePointFromClient(ev);
  if(state.appMode==="build" && (state.tool==="paint"||state.tool==="erase")){ state.paint.down=true; state.paint.last=p; drawBrushDot(p.x,p.y,$("terrainType").value,state.tool==="erase"); return; }
  if(state.appMode==="build" && state.tool==="city"){ state.infraShapes.push({id:"P-"+cryptoRand(),kind:"poi",poiType:$("poiType").value,label:$("poiLabel").value.trim(),x:p.x,y:p.y,rot:0}); renderInfra(); return; }
  if(state.appMode==="build" && state.tool==="stamp"){ state.infraShapes.push({id:"S-"+cryptoRand(),kind:"stamp",stampType:$("stampType").value,label:$("stampLabel").value.trim(),scale:parseFloat($("stampSize").value)||1,x:p.x,y:p.y,rot:0}); renderInfra(); return; }
  if(state.appMode==="build" && state.tool==="label"){ state.infraShapes.push({id:"T-"+cryptoRand(),kind:"label",text:($("labelText").value||"LABEL"),size:parseInt($("labelSize").value,10)||20,x:p.x,y:p.y,rot:0}); renderInfra(); return; }
  if((state.appMode==="build" && ["road","river","border","poly"].includes(state.tool)) || (state.appMode==="plan" && ["front","zone"].includes(state.tool))){ state.temp.points.push(p); return; }
  if(state.appMode==="plan" && state.tool==="note"){ const text=prompt("Note text:"); if(text){state.shapes.push({id:"N-"+cryptoRand(),kind:"note",affil:$("drawAffil").value,drawKind:$("drawKind").value,points:[p],text}); renderOverlays();} }
});
window.addEventListener("pointermove",(ev)=>{ if(state.paint.down && state.appMode==="build" && (state.tool==="paint"||state.tool==="erase")){ paintMove(stagePointFromClient(ev),$("terrainType").value,state.tool==="erase"); } },{passive:false});
window.addEventListener("pointerup",()=>{ state.paint.down=false; state.paint.last=null; });

function applyLayerToggles(){ mapImgEl.style.display=$("togMapImg").checked?"block":"none"; terrainCanvas.style.display=$("togTerrain").checked?"block":"none"; coastSvg.style.display=$("togCoast").checked?"block":"none"; infraSvg.style.display=$("togInfra").checked?"block":"none"; unitsLayer.style.display=$("togUnits").checked?"block":"none"; overlaySvg.style.display=$("togOverlays").checked?"block":"none"; }
["togMapImg","togTerrain","togCoast","togInfra","togUnits","togOverlays"].forEach(id=>$(id).addEventListener("change",applyLayerToggles));

function getTerrainDataURL(){ return terrainCanvas.toDataURL("image/png"); }
function setTerrainFromDataURL(url){ if(!url) return clearTerrain(); const i=new Image(); i.onload=()=>{clearTerrain(); tctx.drawImage(i,0,0);}; i.src=url; }
function pushSnapshot(label=null){ state.snapshots.push({label:label??`Turn ${state.turn}`,turn:state.turn,stage:deep(state.stage),mapDataUrl:state.mapDataUrl,terrainPng:getTerrainDataURL(),coast:deep(state.coast),infraShapes:deep(state.infraShapes),shapes:deep(state.shapes),units:deep(state.units),idCounters:deep(state.idCounters),templates:deep(state.templates)}); $("turnSlider").max=Math.max(0,state.snapshots.length-1); $("turnSlider").value=state.snapshots.length-1; $("turnLabel").textContent=state.turn; }
function loadSnapshot(i){ const s=state.snapshots[i]; if(!s) return; state.turn=s.turn||0; $("turnLabel").textContent=state.turn; applyStageSize(s.stage?.w||1600,s.stage?.h||900); state.mapDataUrl=s.mapDataUrl||""; if(state.mapDataUrl) mapImgEl.src=state.mapDataUrl; else mapImgEl.removeAttribute("src"); setTerrainFromDataURL(s.terrainPng||""); state.coast=s.coast||state.coast; state.infraShapes=s.infraShapes||[]; state.shapes=s.shapes||[]; state.units=s.units||[]; state.idCounters=s.idCounters||{}; if(s.templates) state.templates=s.templates; renderAll(); rebuildUnitTypeDropdown($("unitSearch").value||""); rebuildQuickBar(); }
$("btnSnap").onclick=()=>{pushSnapshot(); toast("Snapshot saved.");}; $("btnNewTurn").onclick=()=>{state.turn++; $("turnLabel").textContent=state.turn;}; $("turnSlider").addEventListener("input",e=>loadSnapshot(parseInt(e.target.value,10)));
$("btnReplay").onclick=()=>{ if(state.replay.on){state.replay.on=false; clearInterval(state.replay.timer); $("btnReplay").textContent="‚ñ∂ Replay"; return;} if(state.snapshots.length<2) return toast("Need 2+ snapshots."); state.replay.on=true; $("btnReplay").textContent="‚è∏ Stop"; let i=parseInt($("turnSlider").value,10)||0; state.replay.timer=setInterval(()=>{i=(i+1)%state.snapshots.length; $("turnSlider").value=i; loadSnapshot(i);},900); };

$("btnExport").onclick=()=>{$("ioBox").value=JSON.stringify({version:"7.4",stage:state.stage,mapDataUrl:state.mapDataUrl,terrainPng:getTerrainDataURL(),coast:state.coast,infraShapes:state.infraShapes,shapes:state.shapes,units:state.units,snapshots:state.snapshots,idCounters:state.idCounters,templates:state.templates},null,2); toast("Exported JSON.");};
$("btnImport").onclick=()=>{try{const p=JSON.parse($("ioBox").value.trim()); applyStageSize(p.stage?.w||1600,p.stage?.h||900); state.mapDataUrl=p.mapDataUrl||""; if(state.mapDataUrl) mapImgEl.src=state.mapDataUrl; else mapImgEl.removeAttribute("src"); setTerrainFromDataURL(p.terrainPng||""); state.coast=p.coast||state.coast; state.infraShapes=p.infraShapes||[]; state.shapes=p.shapes||[]; state.units=p.units||[]; state.snapshots=p.snapshots||[]; state.idCounters=p.idCounters||{}; state.templates=p.templates||deep(DEFAULT_TEMPLATES); renderAll(); rebuildUnitTypeDropdown($("unitSearch").value||""); rebuildQuickBar(); toast("Imported JSON.");}catch(err){toast("Import failed: "+err.message);}};
$("btnNewBlank").onclick=()=>{state.mapDataUrl=""; mapImgEl.removeAttribute("src"); clearTerrain(); state.coast={enabled:true,oceanWidth:3,lakeWidth:2,oceanD:"",lakeD:""}; state.infraShapes=[]; state.shapes=[]; state.units=[]; state.snapshots=[]; state.turn=0; state.idCounters={}; state.templates=deep(DEFAULT_TEMPLATES); renderAll(); rebuildUnitTypeDropdown(""); rebuildQuickBar(); pushSnapshot("Turn 0 (Start)"); toast("New blank scenario.");};
$("btnFactoryReset").onclick=()=>{ if(confirm("Factory reset? Clears autosave + reloads fresh.")){ localStorage.removeItem(AUTOSAVE_KEY); location.reload(); } };

async function exportStagePng(){
  const W=state.stage.w,H=state.stage.h,out=document.createElement("canvas"); out.width=W; out.height=H; const octx=out.getContext("2d");
  if(state.mapDataUrl && $("togMapImg").checked){ const img=await dataUrlToImage(state.mapDataUrl); drawContain(octx,img,0,0,W,H); }
  if($("togTerrain").checked) octx.drawImage(terrainCanvas,0,0);
  if($("togCoast").checked){ const img=await dataUrlToImage(svgToDataUrl(coastSvg,W,H)); octx.drawImage(img,0,0); }
  if($("togInfra").checked){ const img=await dataUrlToImage(svgToDataUrl(infraSvg,W,H)); octx.drawImage(img,0,0); }
  if($("togOverlays").checked){ const img=await dataUrlToImage(svgToDataUrl(overlaySvg,W,H)); octx.drawImage(img,0,0); }
  if($("togUnits").checked){ for(const u of state.units){ const img=await dataUrlToImage("data:image/svg+xml;charset=utf-8,"+encodeURIComponent(unitSvg(u))); octx.drawImage(img,u.x,u.y,u.w,u.h); } }
  const a=document.createElement("a"); a.href=out.toDataURL("image/png"); a.download=`sitmap_turn_${state.turn}.png`; a.click(); toast("Exported PNG.");
}
function svgToDataUrl(svgEl,w,h){ const c=svgEl.cloneNode(true); c.setAttribute("xmlns","http://www.w3.org/2000/svg"); c.setAttribute("width",w); c.setAttribute("height",h); return "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(c)); }
function dataUrlToImage(url){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=url; }); }
function drawContain(ctx,img,x,y,w,h){ const ir=img.width/img.height,r=w/h; let dw=w,dh=h,dx=x,dy=y; if(ir>r){dh=w/ir;dy=y+(h-dh)/2;} else {dw=h*ir;dx=x+(w-dw)/2;} ctx.drawImage(img,dx,dy,dw,dh); }
$("btnExportPng").onclick=exportStagePng;

$("btnAddCustomType").onclick=()=>{ const name=$("customName").value.trim(); if(!name) return toast("Type a unit name first."); const icon=$("customIcon").value, quick=$("customQuick").checked; let k=name.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"")||"custom", i=2; while(state.templates[k]) k=`${k}_${i++}`; state.templates[k]={name,icon,quick,group:"Custom"}; rebuildUnitTypeDropdown($("unitSearch").value||""); rebuildQuickBar(); $("customName").value=""; $("customQuick").checked=false; toast("Custom type added."); };
$("btnResetTypes").onclick=()=>{ state.templates=deep(DEFAULT_TEMPLATES); rebuildUnitTypeDropdown($("unitSearch").value||""); rebuildQuickBar(); toast("Defaults restored."); };
$("unitSearch").addEventListener("input",e=>rebuildUnitTypeDropdown(e.target.value));

function saveAutosave(){ try{ localStorage.setItem(AUTOSAVE_KEY, JSON.stringify({version:"7.4-autosave",stage:state.stage,mapDataUrl:state.mapDataUrl,terrainPng:getTerrainDataURL(),coast:state.coast,infraShapes:state.infraShapes,shapes:state.shapes,units:state.units,snapshots:state.snapshots,idCounters:state.idCounters,templates:state.templates,turn:state.turn})); }catch{} }
function loadAutosave(){ try{ const raw=localStorage.getItem(AUTOSAVE_KEY); if(!raw) return false; const p=JSON.parse(raw); applyStageSize(p.stage?.w||1600,p.stage?.h||900); state.mapDataUrl=p.mapDataUrl||""; if(state.mapDataUrl) mapImgEl.src=state.mapDataUrl; setTerrainFromDataURL(p.terrainPng||""); state.coast=p.coast||state.coast; state.infraShapes=p.infraShapes||[]; state.shapes=p.shapes||[]; state.units=p.units||[]; state.snapshots=p.snapshots||[]; state.idCounters=p.idCounters||{}; state.templates=p.templates||deep(DEFAULT_TEMPLATES); state.turn=p.turn||0; $("turnLabel").textContent=state.turn; renderAll(); rebuildUnitTypeDropdown($("unitSearch").value||""); rebuildQuickBar(); return true; }catch{return false;} }

$("btnDeleteSelected").onclick=()=>{ if(state.selected.kind!=="unit") return; state.units=state.units.filter(u=>u.id!==state.selected.id); clearSelection(); renderUnits(); toast("Deleted."); };
$("btnDuplicateSelected").onclick=()=>{ const u=state.units.find(x=>x.id===state.selected.id); if(!u) return toast("Select a unit first."); const c=deep(u); c.id=nextId($("prefix").value,c.echelon); c.x=clamp(0,state.stage.w-c.w,c.x+24); c.y=clamp(0,state.stage.h-c.h,c.y+24); state.units.push(c); select("unit",c.id); renderUnits(); };
$("btnFocusSelected").onclick=()=>{ const u=state.units.find(x=>x.id===state.selected.id); if(!u) return toast("Select a unit first."); mapArea.scrollLeft=Math.max(0,(u.x+u.w/2)*state.stage.zoom-mapArea.clientWidth/2); mapArea.scrollTop=Math.max(0,(u.y+u.h/2)*state.stage.zoom-mapArea.clientHeight/2); };

window.addEventListener("keydown",(e)=>{ const tag=document.activeElement?.tagName?.toLowerCase(); if((e.key==="Delete"||e.key==="Backspace")&&!['input','textarea','select'].includes(tag)) $("btnDeleteSelected").click(); if(e.key==="Escape") {state.temp.points=[]; toast("Cancelled.");} if(e.key.toLowerCase()==="d") $("btnDuplicateSelected").click(); if(e.key.toLowerCase()==="f") $("btnFocusSelected").click(); });

$("btnHelp").onclick=()=>alert(`WAR TRACKER v7.4

Build: paint/erase terrain, generate ocean/lake coastlines, place POIs/stamps/labels.
Plan: add units, draw fronts/zones/notes, save snapshots and replay.
Keys: Esc cancel, Del delete, D duplicate, F focus.`);


/* ================= Turn-Based Enhancements ================= */
state.turnState={phase:"planning",cp:12,maxCp:12,orderMode:null};
state.history=[];

function updateTurnHud(){
  if($("cpLabel")) $("cpLabel").textContent=state.turnState.cp;
  if($("phaseLabel")) $("phaseLabel").textContent=state.turnState.phase;
}
function addHistory(entry){
  state.history.push({...entry, turn:state.turn, ts:Date.now()});
  renderTurnHistory();
}
function renderTurnHistory(){
  const host=$("turnHistory"); if(!host) return;
  host.innerHTML="";
  state.history.slice().reverse().forEach((h,idx)=>{
    const i=document.createElement("div"); i.className="historyItem";
    i.textContent=`T${h.turn}: ${h.text}`;
    i.onclick=()=>{
      const snapIdx=Math.min(state.snapshots.length-1, h.turn);
      if(snapIdx>=0){ $("turnSlider").value=snapIdx; loadSnapshot(snapIdx); }
    };
    host.appendChild(i);
  });
}
function showTurnSummary(lines){
  const s=$("turnSummary"); if(!s) return;
  s.innerHTML=`<b>Turn ${state.turn} Summary</b><br>${lines.map(escapeHtml).join("<br>")}`;
  s.style.display="block";
  clearTimeout(showTurnSummary._t); showTurnSummary._t=setTimeout(()=>s.style.display="none",4200);
}
function getSelectedUnit(){ return state.units.find(u=>u.id===state.selected.id); }
function queueOrder(type,target){
  const u=getSelectedUnit();
  if(!u){ toast("Select a unit first."); return; }
  if(state.turnState.phase!=="planning"){ toast("Switch to planning phase."); return; }
  if(state.turnState.cp<=0){ toast("No command points left."); return; }
  u.orders=u.orders||[];
  u.orders.push({type,target,turn:state.turn});
  state.turnState.cp=Math.max(0,state.turnState.cp-1);
  updateTurnHud(); renderOverlays();
  addHistory({text:`${u.id} queued ${type}`});
}
function drawOrderPaths(){
  for(const u of state.units){
    const o=u.orders?.[0]; if(!o || !o.target) continue;
    const p=document.createElementNS("http://www.w3.org/2000/svg","line");
    p.setAttribute("x1",u.x+u.w/2); p.setAttribute("y1",u.y+u.h/2);
    p.setAttribute("x2",o.target.x); p.setAttribute("y2",o.target.y);
    p.setAttribute("stroke",affilColor(u.affil)); p.setAttribute("stroke-width","3");
    p.setAttribute("opacity","0.9"); p.setAttribute("class","orderPath");
    overlaySvg.appendChild(p);
  }
}
const _renderOverlays=renderOverlays;
renderOverlays=function(){ _renderOverlays(); drawOrderPaths(); };

async function animateUnitMove(u,to){
  const from={x:u.x,y:u.y}; const dur=420;
  await new Promise(res=>{
    const st=performance.now();
    function tick(now){
      const t=Math.min(1,(now-st)/dur); const e=t<.5?2*t*t:-1+(4-2*t)*t;
      u.x=from.x+(to.x-from.x)*e; u.y=from.y+(to.y-from.y)*e;
      renderUnits();
      if(t<1) requestAnimationFrame(tick); else res();
    }
    requestAnimationFrame(tick);
  });
}
function nearestEnemy(u){
  let best=null,b=1e18;
  for(const e of state.units){ if(e.id===u.id||e.affil===u.affil) continue; const d=dist2({x:u.x,y:u.y},{x:e.x,y:e.y}); if(d<b){b=d;best=e;} }
  return best;
}
async function resolveTurn(){
  state.turnState.phase="resolution"; updateTurnHud();
  const summary=[];
  let casualties=0,moves=0;
  for(const u of state.units){
    const o=u.orders?.shift(); if(!o) continue;
    if(o.type==="move" && o.target){
      await animateUnitMove(u,{x:clamp(0,state.stage.w-u.w,o.target.x-u.w/2),y:clamp(0,state.stage.h-u.h,o.target.y-u.h/2)});
      moves++; addHistory({text:`${u.id} moved`});
    }else if(o.type==="attack"){
      const tgt=nearestEnemy(u);
      if(tgt){ tgt.hp=Math.max(0,(tgt.hp??100)-Math.round((u.combat||60)*0.22)); if(tgt.hp===0){casualties++;}
        addHistory({text:`${u.id} attacked ${tgt.id}`}); summary.push(`${u.id} hit ${tgt.id}`);
      }
    }else if(o.type==="defend"){
      u.morale=(u.morale==="shaken"?"steady":"high"); addHistory({text:`${u.id} dug in`});
    }else if(o.type==="recon"){
      addHistory({text:`${u.id} conducted recon`});
    }
  }
  state.units=state.units.filter(u=>(u.hp??100)>0);
  renderUnits(); renderOverlays();
  stageEl.classList.add("turnFlash"); setTimeout(()=>stageEl.classList.remove("turnFlash"),520);
  summary.unshift(`Moves: ${moves}`,`Casualties: ${casualties}`);
  showTurnSummary(summary.length?summary:["No actions resolved."]);
  state.turn+=1; $("turnLabel").textContent=state.turn;
  state.turnState.phase="planning"; state.turnState.cp=state.turnState.maxCp; updateTurnHud();
  pushSnapshot(`Turn ${state.turn}`);
}

$("btnResolveTurn")?.addEventListener("click",resolveTurn);
$("btnPlanningPhase")?.addEventListener("click",()=>{state.turnState.phase="planning"; updateTurnHud(); toast("Planning phase.");});
$("btnOrderMove")?.addEventListener("click",()=>{state.turnState.orderMode="move"; toast("Click map to set move order.");});
$("btnOrderAttack")?.addEventListener("click",()=>queueOrder("attack",null));
$("btnOrderDefend")?.addEventListener("click",()=>queueOrder("defend",null));
$("btnOrderRecon")?.addEventListener("click",()=>queueOrder("recon",null));
$("btnClearOrders")?.addEventListener("click",()=>{const u=getSelectedUnit(); if(u){u.orders=[]; renderOverlays(); toast("Orders cleared.");}});

interaction.addEventListener("pointerdown",(ev)=>{
  if(state.turnState.orderMode!=="move") return;
  if(state.appMode!=="plan") return;
  const p=stagePointFromClient(ev);
  queueOrder("move",{x:p.x,y:p.y});
  state.turnState.orderMode=null;
  ev.stopImmediatePropagation(); ev.preventDefault();
}, true);

const _addUnit=addUnit;
addUnit=function(){
  _addUnit();
  const u=getSelectedUnit();
  if(!u) return;
  u.hp=u.hp??100;
  u.readiness=$("unitReadiness")?.value||"full";
  u.supply=$("unitSupply")?.value||"well";
  u.morale=$("unitMorale")?.value||"steady";
  u.combat=u.combat||({full:80,reduced:60,minimal:40}[u.readiness]||60);
};

function startUnitDrag(ev,el,u){
  const start=stagePointFromClient(ev), ox=u.x, oy=u.y;
  try{el.setPointerCapture(ev.pointerId);}catch{}
  const mm=(e)=>{ if(e.cancelable) e.preventDefault(); const p=stagePointFromClient(e); u.x=clamp(0,state.stage.w-u.w,ox+p.x-start.x); u.y=clamp(0,state.stage.h-u.h,oy+p.y-start.y); el.style.left=u.x+"px"; el.style.top=u.y+"px";};
  const mu=(e)=>{ try{el.releasePointerCapture(ev.pointerId);}catch{} el.removeEventListener("pointermove",mm); el.removeEventListener("pointerup",mu); el.removeEventListener("pointercancel",mu); window.removeEventListener("pointermove",mm); window.removeEventListener("pointerup",mu); };
  el.addEventListener("pointermove",mm); el.addEventListener("pointerup",mu); el.addEventListener("pointercancel",mu);
  window.addEventListener("pointermove",mm,{passive:false}); window.addEventListener("pointerup",mu,{passive:false});
}

renderUnits=function(){
  unitsLayer.innerHTML="";
  for(const u of state.units){
    const el=document.createElement("div"); el.className="unit"+(state.selected.kind==="unit"&&state.selected.id===u.id?" selected":"");
    el.style.left=u.x+"px"; el.style.top=u.y+"px"; el.style.width=u.w+"px"; el.style.height=u.h+"px"; el.style.transform=`rotate(${u.rot||0}deg)`;
    el.innerHTML=unitSvg(u)+`<div class='unitHealth'><i style='width:${clamp(0,100,u.hp??100)}%'></i></div><div class='unitMeta'><div class='id'>${escapeHtml(u.id)}</div><div class='echelon'>${escapeHtml(u.echelon||"BN")}</div></div>`;
    el.addEventListener("pointerdown",(ev)=>{ if(state.appMode!=="plan"||state.tool!=="selectPlan") return; ev.preventDefault(); state.selected={kind:"unit",id:u.id}; $("selectedBadge").textContent=`Selected: unit ${u.id}`; startUnitDrag(ev,el,u); });
    el.addEventListener("contextmenu",(ev)=>{ ev.preventDefault(); state.selected={kind:"unit",id:u.id}; state.turnState.orderMode="move"; toast("Quick action: click map to move."); });
    unitsLayer.appendChild(el);
  }
  applyLayerToggles();
};

window.addEventListener("keydown",(e)=>{
  if(e.key.toLowerCase()==="m") state.turnState.orderMode="move";
  if(e.key.toLowerCase()==="a") queueOrder("attack",null);
  if(e.key.toLowerCase()==="d" && state.appMode==="plan") queueOrder("defend",null);
});

const _pushSnapshot=pushSnapshot;
pushSnapshot=function(label=null){ _pushSnapshot(label); renderTurnHistory(); };

const _btnNewTurn=$("btnNewTurn").onclick;
$("btnNewTurn").onclick=()=>{ if(_btnNewTurn) _btnNewTurn(); state.turnState.cp=state.turnState.maxCp; updateTurnHud(); state.turnState.phase="planning"; };
updateTurnHud();

function init(){
  rebuildUnitTypeDropdown(""); rebuildQuickBar();
  const restored=loadAutosave();
  if(!restored){ applyStageSize(1600,900); setZoom(1); setAppMode("build"); setTool("paint"); applyLayerToggles(); pushSnapshot("Turn 0 (Start)"); }
  updateInteractionPointerEvents(); setInterval(saveAutosave, 3000); toast(restored?"Restored autosave.":"v7.4 loaded: smooth paint + ocean + lake coastlines.");
}
init();

</script>
</body>
</html>
