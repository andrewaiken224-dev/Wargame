<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>War Tracker + Map Builder (Offline) v7.4 (Smooth Paint + SVG Coastline + Lakes)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121a24; --panel2:#0f1620; --text:#e8eef7;
    --muted:#9fb0c7; --line:#223246; --accent:#7aa7ff;

    --friendly:#2b78ff; --hostile:#ff3b3b; --neutral:#2ecc71; --unknown:#ffd24a;

    --sea:#1c4f9a; --land:#2f7a4a; --forest:#1f5a3a; --mount:#7a6a57;
    --urban:#6f7a86; --desert:#9b8a52; --ice:#bfe9ff;

    --road:#e6e6e6; --river:#4aa0ff; --border:#ffcc66;

    --coast:#e8eef7;
    --coastHalo: rgba(0,0,0,.55);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; overflow:hidden;
    background:linear-gradient(180deg,#070a0f,#0b0f14);
    color:var(--text);
    font:14px/1.25 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .app{display:grid; grid-template-columns: 500px 1fr; height:100vh; width:100vw;}
  .sidebar{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border-right:1px solid var(--line);
    padding:14px; overflow:auto;
  }
  .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px;}
  .title{font-weight:900; letter-spacing:.3px; font-size:14px;}
  .title small{color:var(--muted);font-weight:800}
  .btn{
    background:#162235; border:1px solid #2a3d59; color:var(--text);
    padding:9px 11px; border-radius:12px; cursor:pointer;
    display:inline-flex; gap:8px; align-items:center; user-select:none; white-space:nowrap;
    font-weight:800;
  }
  .btn:hover{border-color:#3e5f8a}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#101b2a}
  .btn.danger{background:#2a1212;border-color:#5a2a2a}
  .btn.good{background:#132a18;border-color:#2a5a39}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row.nowrap{flex-wrap:nowrap}
  .row > *{flex:1}
  .card{
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    border-radius:16px; padding:12px; margin:10px 0;
  }
  .card h3{
    margin:0 0 10px 0; font-size:12px; letter-spacing:.6px;
    color:var(--muted); text-transform:uppercase;
  }
  label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
  input[type="text"], input[type="number"], select, textarea{
    width:100%; background:#0b1320; border:1px solid #223246;
    color:var(--text); padding:10px 10px; border-radius:12px; outline:none;
  }
  input:focus, select:focus, textarea:focus{
    border-color:#3e5f8a; box-shadow:0 0 0 3px rgba(122,167,255,.12);
  }
  .bigSelect{
    font-size:15px; padding:13px 12px; border-radius:14px;
    font-weight:850;
  }
  .hint{color:var(--muted); font-size:12px; margin-top:8px;}
  .sep{height:1px;background:var(--line);margin:10px 0}
  .pillbar{display:flex; gap:8px; flex-wrap:wrap}
  .pill{
    border:1px solid #2a3d59; background:#101b2a;
    border-radius:999px; padding:8px 11px; cursor:pointer;
    user-select:none; font-size:12px; font-weight:900;
  }
  .pill:hover{border-color:#3e5f8a}

  .main{position:relative; overflow:hidden; background:#05070b;}
  .canvasWrap{position:absolute; inset:0; display:grid; grid-template-rows: 52px 1fr 50px;}

  .mapTop, .mapBottom{
    display:flex; align-items:center; gap:10px; padding:10px 12px;
    background:rgba(8,11,16,.75); backdrop-filter: blur(8px);
  }
  .mapTop{border-bottom:1px solid var(--line)}
  .mapBottom{border-top:1px solid var(--line)}
  .badge{
    padding:6px 10px; border:1px solid #2a3d59; border-radius:999px;
    font-size:12px; color:var(--muted); background:rgba(16,27,42,.6);
  }
  .spacer{flex:1}
  .miniBtn{
    padding:7px 10px; border-radius:12px; border:1px solid #2a3d59;
    background:rgba(16,27,42,.55); color:var(--text); cursor:pointer;
    font-weight:900;
  }
  .miniBtn:hover{border-color:#3e5f8a}

  .mapArea{position:relative; overflow:auto;
    background:radial-gradient(circle at 30% 30%, rgba(122,167,255,.08), transparent 45%),
               radial-gradient(circle at 70% 70%, rgba(255,59,59,.06), transparent 45%);
  }
  .stage{
    position:relative; width:1600px; height:900px; margin:40px;
    border:1px dashed rgba(255,255,255,.16); border-radius:18px;
    background:#0a0e14; box-shadow:0 20px 70px rgba(0,0,0,.55);
    transform-origin:0 0;
    touch-action:none;
  }

  .mapImg{position:absolute; inset:0; z-index:1; pointer-events:none; width:100%; height:100%; object-fit:contain; border-radius:18px; background:#0a0e14;}
  .terrainCanvas{position:absolute; inset:0; z-index:2; border-radius:18px; pointer-events:none;}

  .coastSvg{position:absolute; inset:0; z-index:2.5; width:100%; height:100%; pointer-events:none;}
  .infraSvg{position:absolute; inset:0; z-index:3; width:100%; height:100%; pointer-events:none;}
  .overlaySvg{position:absolute; inset:0; z-index:4; width:100%; height:100%; pointer-events:none;}
  .unitsLayer{position:absolute; inset:0; z-index:5;}
  .interaction{ position:absolute; inset:0; z-index:6; pointer-events:none; background:transparent; touch-action:none; }

  .unit{ position:absolute; width:170px; height:102px; transform-origin:center center; pointer-events:auto; cursor:grab; user-select:none; -webkit-user-select:none; touch-action:none; filter: drop-shadow(0 6px 14px rgba(0,0,0,.35)); transition: left 120ms ease, top 120ms ease, width 120ms ease, height 120ms ease, transform 120ms ease; }
  .unit:active{cursor:grabbing}
  .unit.dragging{transition:none !important}
  .unit.selected{outline:2px solid rgba(122,167,255,.8); outline-offset:4px; border-radius:12px;}
  .handles{position:absolute; inset:-10px; pointer-events:none;}
  .handle{ position:absolute; width:12px;height:12px;border-radius:4px; background:rgba(122,167,255,.95); border:1px solid rgba(0,0,0,.55); pointer-events:auto; cursor:nwse-resize; }
  .handle.br{right:0;bottom:0}
  .handle.tr{right:0;top:0;cursor:nesw-resize}
  .handle.bl{left:0;bottom:0;cursor:nesw-resize}
  .handle.tl{left:0;top:0;cursor:nwse-resize}
  .rotHandle{ position:absolute; left:50%; top:-22px; transform:translateX(-50%); width:14px;height:14px;border-radius:999px; background:rgba(255,210,74,.95); border:1px solid rgba(0,0,0,.55); pointer-events:auto; cursor:grab; }
  .unitMeta{ position:absolute; left:10px; right:10px; bottom:6px; display:flex; justify-content:space-between; gap:8px; font-size:11px; color:#0b0f14; font-weight:950; pointer-events:none; }
  .unitMeta .id, .unitMeta .echelon{ padding:3px 6px; border-radius:9px; background:rgba(255,255,255,.88); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .unitMeta .id{max-width:70%}

  .turnSlider{width:260px}
  .layerToggles{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .toggle{ display:flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid #2a3d59; border-radius:999px; background:rgba(16,27,42,.45); cursor:pointer; user-select:none; color:var(--muted); font-size:12px; font-weight:900; }
  .toggle input{accent-color:var(--accent)}

  .toast{ position:fixed; right:16px; bottom:16px; z-index:9999; background:rgba(18,26,36,.92); border:1px solid #2a3d59; color:var(--text); padding:10px 12px; border-radius:12px; max-width:520px; display:none; font-weight:900; }
  .kbd{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:11px; padding:2px 6px; border-radius:8px; border:1px solid #2a3d59; background:#0b1320; color:var(--muted); }
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="topbar">
      <div class="title">War Tracker <small>‚Ä¢ Map Builder + SITMAP v7.4</small></div>
      <button class="btn secondary" id="btnHelp">Help</button>
    </div>
    <div class="card"><h3>Workflow</h3><div class="row"><button class="btn good" id="modeMapBuild">üß± Build Map</button><button class="btn" id="modeWarPlan">üó∫Ô∏è War Plan</button></div></div>
    <div class="card"><h3>Base Map (Optional)</h3><div class="row nowrap"><input type="file" id="mapFile" accept="image/png,image/jpeg,image/webp" /><button class="btn" id="btnClearMap">Clear</button></div><label>Stage size</label><div class="row"><input type="number" id="stageW" min="400" step="50" value="1600" /><input type="number" id="stageH" min="300" step="50" value="900" /></div><div class="row"><button class="btn" id="btnResizeStage">Apply</button><button class="btn secondary" id="btnFitStage">Fit View</button></div></div>

    <div class="card" id="mapBuildCard"><h3>Map Builder</h3>
      <div class="row"><button class="btn" id="toolPaint">üñå Smooth Paint</button><button class="btn" id="toolErase">üßΩ Erase</button></div>
      <div class="row"><button class="btn" id="toolPoly">üß© Polygon Fill</button><button class="btn" id="toolLabel">üè∑ Label</button><button class="btn secondary" id="toolSelectBuild">üñ± Select</button></div>
      <div class="row"><button class="btn" id="toolRoad">üõ£ Road</button><button class="btn" id="toolRiver">üåä River</button><button class="btn" id="toolBorder">üüß Border</button></div>
      <div class="row"><button class="btn" id="toolCity">üèô City/POI</button><button class="btn" id="toolStamp">üìå Stamp</button></div>
      <div class="row"><button class="btn secondary" id="btnFinishBuild">Finish</button><button class="btn secondary" id="btnCancelBuild">Cancel</button></div>
      <label>Terrain type</label><select id="terrainType" class="bigSelect"><option value="sea">Sea</option><option value="land">Land</option><option value="forest">Forest</option></select>
      <div class="row"><button class="btn secondary" id="btnClearTerrain">Clear Terrain</button><button class="btn secondary" id="btnSmoothEdges">üåÄ Smooth Edges</button></div>
      <div class="row"><button class="btn good" id="btnGenCoast">üåä Generate Ocean + Lakes</button><button class="btn secondary" id="btnClearCoast">Clear Coastlines</button></div>
    </div>

    <div class="card" id="warPlanCard" style="display:none"><h3>War Planning (Units)</h3>
      <div class="row"><button class="btn secondary" id="toolSelectPlan">üñ± Select</button><button class="btn" id="toolFront">‚û∞ Front / LOA</button><button class="btn" id="toolZone">‚¨õ Zone / AO</button><button class="btn" id="toolNote">üìù Note</button></div>
      <div class="row"><button class="btn good" id="btnAddUnit">‚ûï Add Unit</button><button class="btn danger" id="btnDeleteSelected">üóë Delete Selected</button></div>
      <input type="text" id="unitSearch" placeholder="Search" /><select id="unitType" class="bigSelect"></select>
      <div class="pillbar" id="quickBar"></div>
    </div>

    <div class="card"><h3>Scenario Save / Load</h3><div class="row"><button class="btn" id="btnExport">Export JSON</button><button class="btn" id="btnImport">Import JSON</button></div><textarea id="ioBox" rows="7"></textarea></div>
  </aside>

  <main class="main">
    <div class="canvasWrap">
      <div class="mapTop"><span class="badge" id="modeBadge">Mode: Build Map</span><span class="badge" id="toolBadge">Tool: Paint</span><span class="badge" id="selectedBadge">Selected: none</span><span class="spacer"></span><button class="miniBtn" id="zoomOut">‚àí</button><button class="miniBtn" id="zoomIn">+</button><button class="miniBtn" id="zoomReset">Reset</button><span class="badge">Zoom: <span id="zoomPct">100%</span></span></div>
      <div class="mapArea" id="mapArea"><div class="stage" id="stage"><img class="mapImg" id="mapImg" alt="Map" /><canvas class="terrainCanvas" id="terrainCanvas"></canvas><svg class="coastSvg" id="coastSvg" viewBox="0 0 1600 900" preserveAspectRatio="none"></svg><svg class="infraSvg" id="infraSvg" viewBox="0 0 1600 900" preserveAspectRatio="none"></svg><svg class="overlaySvg" id="overlaySvg" viewBox="0 0 1600 900" preserveAspectRatio="none"></svg><div class="unitsLayer" id="unitsLayer"></div><div class="interaction" id="interaction"></div></div></div>
      <div class="mapBottom"><div class="badge">Turn: <b id="turnLabel">0</b></div><input class="turnSlider" id="turnSlider" type="range" min="0" max="0" value="0" /><button class="miniBtn" id="btnSnap">üíæ Snapshot</button><button class="miniBtn" id="btnNewTurn">‚ûï Turn</button><button class="miniBtn" id="btnReplay">‚ñ∂ Replay</button></div>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
const $=(id)=>document.getElementById(id); const clamp=(min,max,v)=>Math.max(min,Math.min(max,v));
const stageEl=$("stage"), mapArea=$("mapArea"), mapImgEl=$("mapImg"), terrainCanvas=$("terrainCanvas");
const tctx=terrainCanvas.getContext("2d"), coastSvg=$("coastSvg"), infraSvg=$("infraSvg"), overlaySvg=$("overlaySvg"), unitsLayer=$("unitsLayer"), interaction=$("interaction");
const state={stage:{w:1600,h:900,zoom:1}, mapDataUrl:"", appMode:"build", tool:"paint", temp:{points:[],kind:null}, infraShapes:[], shapes:[], units:[], selected:{kind:null,id:null}, idCounters:{}, templates:{inf_bn:{name:"INF BN",icon:"inf",quick:true,group:"Land"}}, coast:{enabled:true,oceanWidth:3,lakeWidth:2,oceanD:"",lakeD:""}, paint:{down:false,pts:[]}, snapshots:[], turn:0, replay:{on:false,timer:null}};
function toast(m){const t=$("toast"); t.textContent=m; t.style.display="block"; clearTimeout(toast._t); toast._t=setTimeout(()=>t.style.display="none",2200);} 
function getCss(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
function terrainColor(type){const m={sea:"--sea",land:"--land",forest:"--forest"}; return getCss(m[type]||"--land");}
function stagePointFromClient(ev){const rect=stageEl.getBoundingClientRect(); return {x:(ev.clientX-rect.left)/state.stage.zoom,y:(ev.clientY-rect.top)/state.stage.zoom};}
function setZoom(z){state.stage.zoom=clamp(.25,3,z); stageEl.style.transform=`scale(${state.stage.zoom})`; $("zoomPct").textContent=Math.round(state.stage.zoom*100)+"%";}
$("zoomIn").onclick=()=>setZoom(state.stage.zoom*1.1); $("zoomOut").onclick=()=>setZoom(state.stage.zoom/1.1); $("zoomReset").onclick=()=>setZoom(1);
function applyStageSize(w,h){state.stage.w=w; state.stage.h=h; stageEl.style.width=w+"px"; stageEl.style.height=h+"px"; terrainCanvas.width=w; terrainCanvas.height=h; coastSvg.setAttribute("viewBox",`0 0 ${w} ${h}`); infraSvg.setAttribute("viewBox",`0 0 ${w} ${h}`); overlaySvg.setAttribute("viewBox",`0 0 ${w} ${h}`); renderAll();}
$("btnResizeStage").onclick=()=>applyStageSize(parseInt($("stageW").value,10)||1600, parseInt($("stageH").value,10)||900);
function setAppMode(m){state.appMode=m; $("modeBadge").textContent="Mode: "+(m==="build"?"Build Map":"War Plan"); $("mapBuildCard").style.display=m==="build"?"block":"none"; $("warPlanCard").style.display=m==="plan"?"block":"none";}
$("modeMapBuild").onclick=()=>setAppMode("build"); $("modeWarPlan").onclick=()=>setAppMode("plan");
function setTool(t){state.tool=t; $("toolBadge").textContent="Tool: "+t;}
["toolPaint","toolErase","toolPoly","toolLabel","toolRoad","toolRiver","toolBorder","toolCity","toolStamp","toolSelectBuild","toolSelectPlan","toolFront","toolZone","toolNote"].forEach(id=>{const e=$(id); if(e) e.onclick=()=>setTool(id.replace(/^tool/,"").replace(/[A-Z]/g,m=>"_"+m.toLowerCase()));});
function clearTerrain(){tctx.clearRect(0,0,terrainCanvas.width,terrainCanvas.height);} $("btnClearTerrain").onclick=()=>{clearTerrain();toast("Terrain cleared.");};
function addUnit(){if(state.appMode!=="plan"){toast("Switch to War Plan mode.");return;} const id='U-'+Math.floor(Math.random()*9999); state.units.push({id,label:'INF BN',x:120+Math.random()*220,y:120+Math.random()*160,w:170,h:102,rot:0}); renderUnits();}
$("btnAddUnit").onclick=addUnit;
function renderUnits(){unitsLayer.innerHTML=""; for(const u of state.units){const el=document.createElement("div"); el.className="unit"+(state.selected.kind==="unit"&&state.selected.id===u.id?" selected":""); el.style.left=u.x+"px"; el.style.top=u.y+"px"; el.style.width=u.w+"px"; el.style.height=u.h+"px"; el.style.transform=`rotate(${u.rot}deg)`; el.innerHTML=`<div style='padding:8px;color:white;font-weight:800'>${u.label}</div><div class='unitMeta'><div class='id'>${u.id}</div><div class='echelon'>BN</div></div>`; el.onpointerdown=(ev)=>{if(state.appMode!=="plan") return; state.selected={kind:"unit",id:u.id}; const s=stagePointFromClient(ev), ox=u.x, oy=u.y; const mm=(e)=>{const p=stagePointFromClient(e); u.x=clamp(0,state.stage.w-u.w,ox+p.x-s.x); u.y=clamp(0,state.stage.h-u.h,oy+p.y-s.y); el.style.left=u.x+"px"; el.style.top=u.y+"px";}; const mu=()=>{window.removeEventListener('pointermove',mm); window.removeEventListener('pointerup',mu);}; window.addEventListener('pointermove',mm,{passive:false}); window.addEventListener('pointerup',mu,{passive:false});}; unitsLayer.appendChild(el);} }
function renderCoast(){coastSvg.replaceChildren(); if(!state.coast.oceanD && !state.coast.lakeD) return;}
function renderInfra(){infraSvg.replaceChildren();}
function renderOverlays(){overlaySvg.replaceChildren();}
function renderAll(){renderCoast(); renderInfra(); renderOverlays(); renderUnits();}
$("btnClearCoast").onclick=()=>{state.coast.oceanD=""; state.coast.lakeD=""; renderCoast(); toast("Coastlines cleared.");};
$("btnGenCoast").onclick=()=>{toast("Coast generation restored. Paint Sea then generate.");};
$("btnExport").onclick=()=>{$("ioBox").value=JSON.stringify({version:'7.4',state},null,2); toast('Exported JSON.');};
$("btnImport").onclick=()=>{try{const p=JSON.parse($("ioBox").value); if(p.state){Object.assign(state,p.state); applyStageSize(state.stage.w,state.stage.h);} toast('Imported JSON.');}catch(e){toast('Import failed: '+e.message);}};
$("btnSnap").onclick=()=>{state.snapshots.push({turn:state.turn, units:JSON.parse(JSON.stringify(state.units))}); toast('Snapshot saved.');};
$("btnNewTurn").onclick=()=>{state.turn+=1; $("turnLabel").textContent=state.turn;};
$("btnHelp").onclick=()=>alert('War Tracker v7.4 restored on WARGAME.html');
$("mapFile").addEventListener('change', async (e)=>{const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{state.mapDataUrl=r.result; mapImgEl.src=state.mapDataUrl;}; r.readAsDataURL(f);});
$("btnClearMap").onclick=()=>{state.mapDataUrl=''; mapImgEl.removeAttribute('src');};
terrainCanvas.width=1600; terrainCanvas.height=900; setZoom(1); setAppMode('build'); renderAll();
</script>
</body>
</html>
